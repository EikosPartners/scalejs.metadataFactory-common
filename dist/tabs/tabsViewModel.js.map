{"version":3,"sources":["../../src/tabs/tabsViewModel.js"],"names":[],"mappings":"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","file":"tabsViewModel.js","sourcesContent":["import { createViewModel, createViewModels, createViewModel as createViewModelUnbound } from 'scalejs.metadataFactory';\nimport { registerTemplates, registerBindings, template } from 'scalejs.mvvm';\nimport { observable, observableArray, computed, unwrap } from 'knockout';\nimport { getCurrent, setRoute } from 'scalejs.navigation';\nimport { receive, notify } from 'scalejs.messagebus';\nimport { evaluate } from 'scalejs.expression-jsep';\nimport { objectContains, formatText } from './tabUtils';\nimport { extend, cloneDeep } from 'lodash';\nimport { is, has, merge } from 'scalejs';\nimport dataservice from 'dataservice';\n\n    // tabsViewModel\n    // tabs displays clickable links that can be used to modify the contents of an active section\n    // there is one special tabType right now called ajax which will make a new ajax request when the tab is clicked\n    // otherwise the tab will be the mappedChildNodes\n    // todo: refactor tabObj/tabDef to be more clear?\n    var tabTypes = {\n        ajax: ajax,\n        route: route,\n        lazy: lazy\n    };\n\n    function disposeNodes(nodes) {\n        unwrap(nodes).forEach(node => {\n            node.dispose && node.dispose();\n            disposeNodes(node.mappedChildNodes || []);\n        });\n    }\n\n    function lazy(tabObj, tab) {\n        var mappedChildNodes = observableArray(),\n            setActiveTab = tabObj.setActiveTab,\n            tabTemplate = tabObj.tabTemplate,\n            context = this;\n        \n        tabObj.mappedChildNodes = mappedChildNodes;\n\n        tabObj.setActiveTab = function (newRoute) {\n            if (!mappedChildNodes().length || !tabObj.keepCache) {\n                if (mappedChildNodes().length) {\n                    disposeNodes(mappedChildNodes());\n                }\n                mappedChildNodes(createViewModels.call(context, tab.children));\n                tabTemplate({\n                    template: {\n                        name: 'metadata_items_template',\n                        data: mappedChildNodes()\n                    },\n                    tabObj: tabObj\n                });\n                setActiveTab(newRoute);\n            } else {\n                setActiveTab(newRoute);\n            }\n        };\n\n        return tabObj;\n    }\n\n    function ajax(tabObj, tab) {\n        var tabParams = tab.options && tab.options.params,\n            setActiveTab = tabObj.setActiveTab,\n            tabTemplate = tabObj.tabTemplate,\n            mappedChildNodes = observableArray(),\n            context = this;\n\n        // update everything when mapped child nodes changes\n        tabObj.mappedChildNodes = mappedChildNodes;\n\n        // override tab setActiveTab so that new ajax request is made for first load\n        tabObj.setActiveTab = function(newRoute) {\n            if (!tabTemplate() || !tabObj.keepCache) {\n                if(tabTemplate()) {\n                    tabTemplate().template.data.forEach(function (node) {\n                        // todo - call dispose on mapped child nodes of each node\n                        if (node.dispose) {\n                            node.dispose();\n                        }\n                    });\n                }\n                dataservice.get({uri:tab.ajax}, function (err, metadata) {\n                    if (err) {\n                        console.error('there is an error',err);\n                    }\n\n                    try {\n                        mappedChildNodes(createViewModels.call(context, Array.isArray(metadata) ? metadata : [metadata]));\n                    } catch (err) {\n                        console.error(err);\n                    }\n\n\n                    // need to pass tabObj to the activeTabRegion to be able to code dynamic logic in custom binding\n                    tabTemplate({\n                        template: {\n                            name: 'metadata_items_template',\n                            data: mappedChildNodes()\n                        },\n                        tabObj: tabObj\n                    });\n                    setActiveTab(newRoute);\n                });\n            } else {\n                setActiveTab(newRoute);\n            }\n        }\n        // todo refactor to pass params\n        if (tabParams) {\n            tab.ajax = getCurrent().query && getCurrent().query[tabParams] ? tab.ajax + getCurrent().query[tabParams] : tab.ajax;\n        }\n\n        return tabObj;\n    }\n\n    // tabObj - the ViewModel for the tab itself (not the contents)\n    // tab - the definition of the Tab contents\n    function route(tabObj, tab) {\n        var context = this; // want to pass context incase it has data\n\n        // override tab setActiveTab so that a route is performed\n        tabObj.setActiveTab = function () {\n            // merge the params from route with current query as not to overwrite it\n            // also merge with the tabObj.tabDef.params so that the tab initializes correctly\n            // for the objectContains check below, if the tabDef.params is part of the query it will use that tab as the initial tab\n            // so we need to make sure, that if we're setting a tabRoute, that the params of the last tab are overwriten with the params in the current tab\n            // so you dont get another route accidentally\n            createViewModel.call(context, {\n                type: 'action',\n                actionType: 'route',\n                options: {\n                    target: tab.route.target,\n                    params: merge(\n                        getCurrent().query,\n                        tabObj.tabDef.params,\n                        tab.route.params\n                    )\n                }\n            }).action();\n        }\n        return tabObj;\n    }\n\n    export default function (node, metadata) {\n        var context = this,\n            createViewModel = createViewModelUnbound.bind(context), //ensures context is passed\n            options = node.options || {},\n            mappedChildNodes,\n            activeTabRegion = observable({}),\n            initialized = false,\n            subs = [],\n            query = getCurrent().query,\n            tabs = [],\n            initialActiveTab;\n\n        // when tabs are selected update the tab route\n        // do not update tabroute on initialization, just replace\n        function setTabRoute(tabDef) {\n            var currentRoute = getCurrent().route + (getCurrent().path ? '/' + getCurrent().path : '' ),\n                query = getCurrent().query;\n            setRoute(tabDef.target || currentRoute, merge(query,tabDef.params), false, initialized);\n            initialized = true;\n        }\n\n        // zip the children tabs with the tab defs\n        node.children.forEach(function (tab, index) {\n            var tabTemplate = observable(), // can by dynamic because of ajax tabs\n                tabDef = typeof node.headers[index] === 'string' ? { text: node.headers[index] } : node.headers[index],\n                tabName = tabDef.computed ? computed(function () {\n                    return formatText(tabDef.text, context.getValue);\n                }) : tabDef.text,\n                tabObj = {\n                    tabName: tabName,\n                    tabDef: tabDef,\n                    tabTemplate: tabTemplate,\n                    keepCache: tab.cache || node.cache\n                },\n                tabViewModel;\n\n           // sets the active tab region to the tab template\n           // sets newRoute if defined, else sets tabRoute\n           tabObj.setActiveTab = function (newRoute) {\n               if (options.validations && options.validations[tabDef.text]) {\n                   notify(options.validations[tabDef.text], {\n                       successCallback: function() {\n                           activeTabRegion(tabTemplate());\n                           setTabRoute(newRoute || tabDef);\n                       }\n                   });\n               } else {\n                    activeTabRegion(tabTemplate());\n                    setTabRoute(newRoute || tabDef);\n               }\n           };\n\n           // tab is active when the active region is the template\n           tabObj.isActive = computed(function () {\n                return activeTabRegion() === tabTemplate();\n            });\n\n            // create tabViewModel from type if defined\n            // else call createViewModel\n            if (tabTypes[tab.type]) {\n                tabViewModel = tabTypes[tab.type].call(context, tabObj, tab)\n            } else {\n                tabViewModel = createViewModel(tab)\n                tabTemplate(template('metadata_item_template', tabViewModel));\n            }\n\n            extend(tabObj, tabViewModel);\n\n            // visible expression binding using context' getValue\n            if(has(tabDef.visible)) {\n                tabObj.visible = is(tabDef.visible, 'boolean') ?\n                    tabDef.visible\n                    : computed(function() {\n                        return evaluate(tabDef.visible, context.getValue || function (id) {\n                            console.error('Trying to evaluate a binding when getValue isnt specified on the context', tabObj);\n                        });\n                    });\n            } else {\n                tabObj.visible = true;\n            }\n\n            tabs.push(tabObj);\n\n            // sets the active tab if defined in the query or tabDef\n            if(tabDef.isActive || tabDef.params && query && objectContains(query, tabDef.params)) {\n                initialActiveTab = tabObj;\n            }\n        });\n\n        if (initialActiveTab) {\n            initialActiveTab.setActiveTab();\n        } else if (!activeTabRegion().template) {\n            // initialize to first tab if we havent routed to a specific tab\n            \n            // will set first visible tab to active tab\n            let initialTab = tabs.filter((tab) => {\n                return unwrap(tab.visible);\n            })[0];\n\n            initialTab && initialTab.setActiveTab();\n        }\n\n        // receive events to set active tab\n        if(node.id) {\n            subs.push(receive(node.id +'.setActiveTab', function (params) {\n                tabs.some(function(tab) {\n                    // if activeTab: 'x' is in both objects, set the active tab\n                    // and write this better..maybe use ids\n                    if(objectContains(params, tab.tabDef.params)) {\n                        tab.setActiveTab(merge(cloneDeep(tab.tabDef), { params: params }));\n                    }\n                });\n            }));\n\n            subs.push(receive(node.id+'.setNextTab', function () {\n                var currentIndex =  0,\n                    newIndex;\n\n                tabs.some(function(tab, index) {\n                    if (activeTabRegion() == tab.tabTemplate()) {\n                        currentIndex = index;\n                    }\n                })\n\n                while(newIndex === undefined) {\n                    if (!tabs[(currentIndex+1) % tabs.length].isChild) {\n                        newIndex = currentIndex +1;\n                    } else {\n                        currentIndex++\n                    }\n                }\n\n                tabs[newIndex].setActiveTab();\n            }));\n        }\n\n        return merge(node, {\n            tabs: tabs,\n            mappedChildNodes: tabs,\n            activeTabRegion: activeTabRegion,\n            context: this,\n            dispose: function () {\n                subs.forEach(function (sub) {\n                    sub.dispose();\n                });\n\n                tabs.forEach(function (tab) {\n                    var tabViewModels = tab.tabTemplate() && tab.tabTemplate().template.data;\n                    // why is tab viewmodels an array, anyway?\n                    if (tabViewModels && !Array.isArray(tabViewModels)) {\n                        tabViewModels = [tabViewModels];\n                    }\n                    (tabViewModels || []).forEach(function(vm) {\n                        vm && vm.dispose && vm.dispose();\n                    });\n                });\n            }\n        });\n    };\n"]}