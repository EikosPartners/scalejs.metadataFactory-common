{"version":3,"sources":["../../src/store/storeViewModel.js"],"names":["node","keyMap","storeKey","storeValue","dataSourceEndpoint","options","subs","console","warn","fetchData","ajax","error","results","setValue","value","resultsKey","mapArrayToDictionaryWithKey","reduce","obj","item","key","aggregateMappedItems","push","resultsValueKey","id","dispose","forEach","sub"],"mappings":";;;;;;kBAgCmB,UAAUA,IAAV,EAAgB;AAC3B,QAAIC,SAASD,KAAKC,MAAL,IAAe,EAA5B;AAAA,QACIC,WAAWF,KAAKE,QADpB;AAAA,QAEIC,aAAaH,KAAKG,UAFtB;AAAA,QAGIC,qBAAqBJ,KAAKI,kBAH9B;AAAA,QAIIC,UAAUL,KAAKK,OAAL,IAAgB,EAJ9B;AAAA,QAKIC,OAAO,EALX;;AAOA,QAAI,CAACJ,QAAL,EAAe;AACXK,gBAAQC,IAAR,CAAa,sCAAb,EAAqDR,IAArD;AACA;AACH;;AAED,QAAI,CAACI,kBAAD,IAAuB,CAACD,UAA5B,EAAwC;AACpCI,gBAAQC,IAAR,CAAa,0EAAb,EAAyFR,IAAzF;AACA;AACH;;AAED;AACA;AACA,aAASS,SAAT,GAAqB;AACjB,8BAAYC,IAAZ,CAAiBN,kBAAjB,EAAqC,UAAUO,KAAV,EAAiBC,OAAjB,EAA0B;AAC3D,gBAAID,KAAJ,EAAW;AACPJ,wBAAQI,KAAR,CAAc,qCAAd,EAAqDX,IAArD,EAA2DW,KAA3D;AACA,kCAAYE,QAAZ,CAAqBX,QAArB,EAA+BS,KAA/B;AACA;AACH;AACD,gBAAIG,QAAQb,OAAOc,UAAP,GAAoBH,QAAQX,OAAOc,UAAf,CAApB,GAAiDH,OAA7D;;AAEA,gBAAIP,QAAQW,2BAAZ,EAAyC;AACrCF,wBAAQA,MAAMG,MAAN,CAAa,UAAUC,GAAV,EAAeC,IAAf,EAAqB;AACtC,wBAAIC,MAAMf,QAAQW,2BAAlB;AACA,wBAAIX,QAAQgB,oBAAZ,EAAkC;AAC9BH,4BAAIC,KAAKC,GAAL,CAAJ,IAAiBF,IAAIC,KAAKC,GAAL,CAAJ,KAAkB,EAAnC;AACAF,4BAAIC,KAAKC,GAAL,CAAJ,EAAeE,IAAf,CAAoBH,IAApB;AACH,qBAHD,MAGO;AACHD,4BAAIC,KAAKC,GAAL,CAAJ,IAAiBnB,OAAOsB,eAAP,GAAyBJ,KAAKlB,OAAOsB,eAAZ,CAAzB,GAAwDJ,IAAzE,CADG,CAC4E;AAClF;AACD,2BAAOD,GAAP;AACH,iBATO,EASL,EATK,CAAR;AAUH;AACD,8BAAYL,QAAZ,CAAqBX,QAArB,EAA+BY,KAA/B;AACH,SArBD;AAsBH;;AAED,QAAGV,kBAAH,EAAuB;AACnBK,oBADmB,CACN;;AAEb,YAAIT,KAAKwB,EAAT,EAAa;AAAE;AACXlB,iBAAKgB,IAAL,CAAU,uBAAQtB,KAAKwB,EAAL,GAAU,UAAlB,EAA8B,YAAY;AAChDf;AACH,aAFS,CAAV;AAGH;AACJ;;AAED,QAAGN,UAAH,EAAe;AACX,0BAAYU,QAAZ,CAAqBX,QAArB,EAA+BC,UAA/B;AACH;;AAGD,WAAO;AACCsB,iBAAS,mBAAY;AACrBnB,iBAAKoB,OAAL,CAAa,UAAUC,GAAV,EAAe;AACxBA,oBAAIF,OAAJ;AACH,aAFD;AAGH;AALE,KAAP;AAOH,C;;AAnGL;;;;AACA;;;;AACA;;;;AAiGK;;AA/FD;;AAEA","file":"storeViewModel.js","sourcesContent":["import noticeboard from 'scalejs.noticeboard';\r\nimport dataservice from 'dataservice';\r\nimport { receive } from 'scalejs.messagebus';\r\n\r\n    //TODO: Rename results to resultsKey\r\n\r\n    /**\r\n     * Store: a component that takes a dataSourceEndpoint\r\n     * and adds the results to the noticeboard.\r\n     * It has no viewmodel and does not accept children.\r\n     *\r\n     * @module store\r\n     *\r\n     * @param {object} node\r\n     *  The configuation object for the module\r\n     * @param {string} node.type='store'\r\n     * The type of the node is store     *\r\n     * @param {object} node.storeKey\r\n     *  The key that the results are stored on in the noticeboard\r\n     * @param {object|Object[]} node.dataSourceEndpoint\r\n     *  An object defining the endpoint(s) that makes the ajax calls\r\n     * @param {string} node.dataSourceEndpoint.uri\r\n     *   The uri for the endpoint\r\n     * @param {string} [node.dataSourceEndpoint.url]\r\n     *  The url for the endpoint\r\n     * @param {object} [node.dataSourceEndpoint.options]\r\n     *  Options for the ajax call\r\n     * @param {object} [node.keyMap]\r\n     *  A mapper object to map keys\r\n     * @param {object} [node.keyMap.result]\r\n     *  Map the results from the ajax call with this key\r\n     */\r\n    export default function (node) {\r\n        var keyMap = node.keyMap || {},\r\n            storeKey = node.storeKey,\r\n            storeValue = node.storeValue,\r\n            dataSourceEndpoint = node.dataSourceEndpoint,\r\n            options = node.options || {},\r\n            subs = [];\r\n\r\n        if (!storeKey) {\r\n            console.warn('Cannot store data without a storeKey', node);\r\n            return;\r\n        }\r\n\r\n        if (!dataSourceEndpoint && !storeValue) {\r\n            console.warn('Cannot set storeKey with data without a dataSourceEndpoint or storeValue', node);\r\n            return;\r\n        }\r\n\r\n        //todo: check if storeKey is already in the noticeboard\r\n        // option to persist data and not request endpoint multiple times\r\n        function fetchData() {\r\n            dataservice.ajax(dataSourceEndpoint, function (error, results) {\r\n                if (error) {\r\n                    console.error('Error when retrieving data for node', node, error);\r\n                    noticeboard.setValue(storeKey, error);\r\n                    return;\r\n                }\r\n                var value = keyMap.resultsKey ? results[keyMap.resultsKey] : results;\r\n\r\n                if (options.mapArrayToDictionaryWithKey) {\r\n                    value = value.reduce(function (obj, item) {\r\n                        var key = options.mapArrayToDictionaryWithKey;\r\n                        if (options.aggregateMappedItems) {\r\n                            obj[item[key]] = obj[item[key]] || [];\r\n                            obj[item[key]].push(item);\r\n                        } else {\r\n                            obj[item[key]] = keyMap.resultsValueKey ? item[keyMap.resultsValueKey] : item; // will overwrite any existing items with the key\r\n                        }\r\n                        return obj;\r\n                    }, {})\r\n                }\r\n                noticeboard.setValue(storeKey, value);\r\n            });\r\n        }\r\n\r\n        if(dataSourceEndpoint) {\r\n            fetchData(); //initial call\r\n\r\n            if (node.id) { //setup refresh receiver if store has id\r\n                subs.push(receive(node.id + '.refresh', function () {\r\n                    fetchData();\r\n                }));\r\n            }\r\n        }\r\n\r\n        if(storeValue) {\r\n            noticeboard.setValue(storeKey, storeValue);\r\n        }\r\n\r\n\r\n        return {\r\n                dispose: function () {\r\n                subs.forEach(function (sub) {\r\n                    sub.dispose();\r\n                });\r\n            }\r\n        }\r\n    };\r\n"]}