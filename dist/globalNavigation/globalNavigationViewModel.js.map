{"version":3,"sources":["../../src/globalNavigation/globalNavigationViewModel.js"],"names":["globalNavigation","node","routes","observableArray","navLinks","activeLink","walkGetTypes","nodes","reduce","types","childNode","concat","type","children","forEach","route","addNav","routeInfo","name","get","replace","path","ajax","uri","err","metadata","uniq","Array","isArray","filter","indexOf","content","init","initial","subscribe","oldRoutes","routeOptions","removeNav","text","dispose"],"mappings":";;;;;kBAOwBA,gB;;AAPxB;;AACA;;AACA;;;;AACA;;AACA;;;;AACA;;;;;;AAEe,SAASA,gBAAT,CAA0BC,IAA1B,EAAgC;AAC3C,QAAMC,SAAS,mBAAGC,eAAH,CAAmBF,KAAKC,MAAxB,CAAf;AAAA,QACIE,WAAW,qBAAWA,QAD1B;AAAA,QAEIC,aAAa,qBAAWA,UAF5B;;AAIA,aAASC,YAAT,CAAsBC,KAAtB,EAA6B;AACzB,eAAO,CAACA,SAAS,EAAV,EACFC,MADE,CACK,UAACC,KAAD,EAAQC,SAAR;AAAA,mBAAsBD,MAAME,MAAN,CAAa,CAACD,UAAUE,IAAX,CAAb,EAC7BD,MAD6B,CACtBL,aAAaI,UAAUG,QAAvB,CADsB,CAAtB;AAAA,SADL,EAEwC,EAFxC,CAAP;AAGH;;AAEDX,aAASY,OAAT,CAAiB,UAACC,KAAD,EAAW;AACxB,6BAAWC,MAAX,CAAkBD,KAAlB,EAAyB,UAACE,SAAD,EAAe;AACpC,gBAAMC,OAAOH,MAAMI,GAAN,CAAUC,OAAV,CAAkB,QAAlB,EAA4BH,UAAUI,IAAV,SAAqBJ,UAAUI,IAAV,CAAeD,OAAf,CAAuB,GAAvB,EAA4B,GAA5B,CAArB,GAA0D,EAAtF,CAAb;AACA,kCAAYE,IAAZ,CAAiB,EAAEC,KAAKL,IAAP,EAAjB,EAAgC,UAACM,GAAD,EAAMC,QAAN,EAAmB;AAC/C,oBAAID,GAAJ,EAAS;AACL;AACH;AACD,oBAAMf,QAAQ,iBAAEiB,IAAF,CAAOpB,aAAaqB,MAAMC,OAAN,CAAcH,QAAd,IAA0BA,QAA1B,GAAqC,CAACA,QAAD,CAAlD,CAAP,EACTI,MADS,CACF;AAAA,2BACJjB,QAAQ,mCAAqBkB,OAArB,CAA6BlB,IAA7B,MAAuC,CAAC,CAD5C;AAAA,iBADE,CAAd;;AAKA;;AAEA,iCAAOmB,OAAP,CAAeN,QAAf;AACH,aAZD;AAaH,SAfD;AAgBH,KAjBD;;AAmBA,yBAAWO,IAAX,CAAgB/B,KAAKgC,OAAL,IAAgB,CAAhC;;AAEA/B,WAAOgC,SAAP,CAAiB,UAACC,SAAD,EAAe;AAC5BA,kBAAUrB,OAAV,CAAkB,UAACsB,YAAD,EAAkB;AAChC,iCAAWC,SAAX,CAAqBD,aAAaE,IAAlC;AACH,SAFD;AAGH,KAJD,EAIG,IAJH,EAIS,cAJT;;AAMA,WAAO,qBAAMrC,IAAN,EAAY;AACfG,0BADe;AAEfC,8BAFe;AAGfkC,iBAAS,mBAAY;AACjBrC,mBAAO,EAAP;AACH;AALc,KAAZ,CAAP;AAOH","file":"globalNavigationViewModel.js","sourcesContent":["import { getRegisteredTypes } from 'scalejs.metadataFactory';\r\nimport { navigation, layout } from 'scalejs.navigation';\r\nimport dataservice from 'dataservice';\r\nimport { merge } from 'scalejs';\r\nimport ko from 'knockout';\r\nimport _ from 'lodash';\r\n\r\nexport default function globalNavigation(node) {\r\n    const routes = ko.observableArray(node.routes),\r\n        navLinks = navigation.navLinks,\r\n        activeLink = navigation.activeLink;\r\n\r\n    function walkGetTypes(nodes) {\r\n        return (nodes || [])\r\n            .reduce((types, childNode) => types.concat([childNode.type])\r\n            .concat(walkGetTypes(childNode.children)), []);\r\n    }\r\n\r\n    routes().forEach((route) => {\r\n        navigation.addNav(route, (routeInfo) => {\r\n            const name = route.get.replace('{path}', routeInfo.path ? `_${routeInfo.path.replace('/', '_')}` : '');\r\n            dataservice.ajax({ uri: name }, (err, metadata) => {\r\n                if (err) {\r\n                    return;\r\n                }\r\n                const types = _.uniq(walkGetTypes(Array.isArray(metadata) ? metadata : [metadata]))\r\n                    .filter(type =>\r\n                        type && getRegisteredTypes().indexOf(type) === -1\r\n                    );\r\n\r\n                // console.log('Missing types:', types);\r\n\r\n                layout.content(metadata);\r\n            });\r\n        });\r\n    });\r\n\r\n    navigation.init(node.initial || 0);\r\n\r\n    routes.subscribe((oldRoutes) => {\r\n        oldRoutes.forEach((routeOptions) => {\r\n            navigation.removeNav(routeOptions.text);\r\n        });\r\n    }, null, 'beforeChange');\r\n\r\n    return merge(node, {\r\n        navLinks,\r\n        activeLink,\r\n        dispose: function () {\r\n            routes([]);\r\n        }\r\n    });\r\n}"]}