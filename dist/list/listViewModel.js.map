{"version":3,"sources":["../../src/list/listViewModel.js"],"names":["listViewModel","listItems","DELETE","del","DELETE_FLAG","deleteFlag","itemDef","context","clonedItem","cloneDeep","template","id","undefined","name","data","isNew","call","getValue","deleteRow","options","clearOnDelete","item","itemDictionary","setValue","node","keyMap","rows","isShown","readonly","deleteRows","minRequiredRows","showRemoveButton","mappedChildNodes","unique","visibleRows","scrolled","initialData","addButtonRendered","bind","setReadonly","bool","forEach","row","rowViewModel","initialValues","items","rowContext","metadata","editMode","dict","Object","keys","reduce","d","itemViewModels","rowReadonly","error","inputValue","index","indexOf","prop","map","_item","input","console","type","ret","visible","add","rowVm","remove","dispose","push","unshift","setTimeout","some","rendered","hasFocus","originalData","peek","listData","originalRowItems","dataObj","itemKey","filter","obj","dontSendIfEmpty","sendNullIfEmpty","length","initialize","removeAll","trackDiffChanges","set","i","newData","Array","isArray","reverse","lastRow","validations","required","subscribeToData","warn","subscribe","infinite","newRows","slice","event","elem","target","currentRows","scrollTop","scrollHeight","offsetHeight","seed","allRows","showRemove"],"mappings":"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","file":"listViewModel.js","sourcesContent":["import { observable, observableArray, computed, unwrap } from 'knockout';\nimport { createViewModel } from 'scalejs.metadataFactory';\nimport { evaluate } from 'scalejs.expression-jsep';\nimport noticeboard from 'scalejs.noticeboard';\nimport { merge, has, is } from 'scalejs';\nimport _ from 'lodash';\n\n    // todo: revisit comments below\n    // listViewModel is a component which manages a simple list\n    // - items - items are what are used to make up the rows in the list\n    // - options\n    // -- addRows - if false add button does not appear\n    // -- deleteRows - if false delete button does not appear\n    // -- minRequiredRows - initializes list with # of rows and wont let user delete\n\n    //TODO: Refactor Session\n    //- implement \"parent passes to children\" pattern for labels\n    //- brainstorm cleaner \"itemViewModel\" imp.\n    //- general clean up/renaming/documenting session\n    // ...add more refactor session goals here!\n    /**\n     *  list is the component to use when wanting to group items into enumerable lists.\n     *  There are two types of lists: responsive form lists (default) and table lists (+listAdvanced wrapper)\n     *  The underlying data model for a list is an array of objects.\n     *\n     * @module list\n     *\n     * @param {object} node\n     *  The configuration specs for the component.\n     * @param {string} [node.id]\n     *  The id of the list becomes the key in the data for all the children of the list.\n     *\n     */\n    let listItems = {\n        DELETE: del,\n        DELETE_FLAG: deleteFlag\n    };\n\n    function del(itemDef) {\n        var context = this,\n            clonedItem = _.cloneDeep(itemDef);\n\n        delete clonedItem.template; // prevent scalejs merge issue\n\n        return merge(clonedItem, {\n            id: undefined,\n            template: {\n                name: itemDef.template ||'list_del_template',\n                data: context\n            }\n        })\n    }\n\n    function deleteFlag(itemDef) {\n        var context = this;\n        // the id will be the propertu\n        // getValue - return if it was deleted or not\n        return context.isNew ? del.call(context, itemDef) : merge(context, {\n            template: 'list_del_flag_template',\n            getValue: function () {\n                return context.deleteFlag() ? \"T\" : \"F\";\n            },\n            deleteRow: function () {\n                context.deleteFlag(true);\n                if(itemDef.options && itemDef.options.clearOnDelete) {\n                    var item = context.itemDictionary()[itemDef.options.clearOnDelete];\n                    if(item && item.setValue) {\n                        item.setValue(0);\n                    }\n                }\n            }\n        }, itemDef)\n    }\n\n\n\n    export default function listViewModel(node) {\n        var  keyMap = node.keyMap || {},\n            rows = observableArray(),\n            options = node.options || {},\n            isShown = observable(true),\n            context = this || {},\n            readonly = observable((context.readonly && context.readonly()) || false), //initialize to the context's state as determined by the form generally\n            deleteRows = observable(options.deleteRows !== false),\n            minRequiredRows = 0,\n            showRemoveButton,\n            // addButtonContext = node.addButtonContext,\n            mappedChildNodes = observableArray(),\n            data = observable(node.data),\n            unique = {},\n            visibleRows = observableArray(),\n            scrolled,\n            initialData = _.cloneDeep(node.data) || [],\n            addButtonRendered = is(node.addButtonRendered, 'string') ? \n                computed(evaluate.bind(null, node.addButtonRendered, context.getValue)) \n                : observable(node.addButtonRendered !== false);\n\n        function setReadonly (bool) {\n          readonly(bool); //sets readonly state of the list\n          rows().forEach(function (row) { //sets readonly state of each row\n            row.readonly(bool)\n          });\n        }\n\n        // rowViewModel\n        // called on each add\n        // or when data is set with initial values\n        function rowViewModel(initialValues, isNew) {\n            var items = observableArray(), // observable array to hold the items in the row\n                itemDictionary = observable({}), // observable dictionary to hold the items and other properties\n                rowContext = {\n                    metadata: context.metadata, // reference to the parent metadata\n                    rows: rows,\n                    unique: unique,\n                    isNew: isNew,\n                    itemDictionary: itemDictionary,\n                    editMode: observable(false), //for styling - maybe better if called isActiveRow\n                    deleteFlag: observable(false),\n                    data: computed(function () {\n                        var dict = itemDictionary();\n                         return Object.keys(dict).reduce(function (d, id) {\n                            var item = dict[id];\n                            if(item.getValue) {\n                                d[id] = item.getValue();\n                            } else {\n                                d[id] = item;\n                            }\n                            return d;\n                        }, {});\n                    })\n                },\n                row = {}, // the row itself\n                itemViewModels,\n                rowReadonly;\n\n            // initialize row readonly as the list's state\n            rowContext.readonly = observable(readonly());\n\n            // rowReadonly - string to run thrown expression parser to show/hide rows\n            if (is(options.rowReadonly, 'string')) {\n                rowReadonly = computed(function () {\n                    if (rowContext.readonly && rowContext.readonly()) {\n                        return true; //if readonly is true on context, then row is readonly\n                    }\n                    // else, eval the expression to determine if the row is readonly\n                    return evaluate(options.rowReadonly, function (id) {\n                        var item = itemDictionary()[id];\n                        if (item && item.getValue) {\n                            return item.getValue();\n                        }\n                    });\n                });\n            }\n\n            // can be utilized by expression parser to get error for an id\n            function error(id) {\n                var item = itemDictionary()[id];\n                if(item && item.inputValue && item.inputValue.error) {\n                    return item.inputValue.error();\n                }\n            }\n\n            // accurately calculates the index of the row in the list\n            rowContext.index = computed(function () {\n                return rows().indexOf(row);\n            });\n\n            // getValueById function for expression parsing\n            // todo. refactor this\n            rowContext.getValue = function (id) {\n               if (id === 'index') {\n                    return rowContext.index();\n                }\n                if (id === 'list') {\n                    return rows();\n                }\n                if (id === 'row') {\n                    return rows()[rowContext.index()];\n                }\n                if (id === 'error') {\n                    return error;\n                }\n                // check the item dictionary\n                var item = itemDictionary()[id];\n                if (item && item.getValue) {\n                    return item.getValue();\n                }\n\n                // if the item doesnt have getValue, return itself\n                if (has(item)) {\n                    return unwrap(item);\n                }\n\n                let prop = rowContext[id];\n\n                if (has(prop)) {\n                    return unwrap(prop);\n                }\n\n                return context.getValue(id);\n            }\n\n\n            itemViewModels = node.items.map(function (_item) {\n                var item = _.cloneDeep(_item); // deep clone the item as we might mutate it before passing to createViewModels\n\n                // add readonly computed to the item before passing it to input\n                // input will use the already defined observable if it exists\n                // but, if the input already has readonly set on it, dont get readonly from row..\n                if (rowReadonly && item.input && !has(item.input.readonly)) {\n                    item.input.readonly = rowReadonly;\n                }\n\n                if(item.options && item.options.unique) {\n                    if(!item.id) {\n                        console.error('Cannot set unique on item without id');\n                    } else if (!unique[item.id]) { //only create once\n                        unique[item.id] = observableArray();\n                    }\n                }\n\n                // todo - clean this up?\n                if (listItems[item.type]) {\n                    var ret = listItems[item.type].call(rowContext, item);\n                    if (item.visible) {\n                        ret.visible = computed(function () {\n                            return evaluate(item.visible, rowContext.getValue);\n                        });\n                    }\n                    return ret;\n                } else {\n                    return createViewModel.call(rowContext, item);\n                }\n            });\n\n            // if there are initial values, update the children\n            if (initialValues) {\n                itemViewModels.forEach(function(item) {\n                    if (initialValues[item.id]) { // allow for JSON default values don't get overwritten by server data that doesn't contain data\n                        item.setValue && item.setValue(initialValues[item.id]);\n                    }\n                });\n            }\n\n            // update items obsArr\n            items(itemViewModels);\n\n            // generate itemDictionary from the itemViewModels\n            // also add each item's inputValue directly on the row\n            // this is for MemberExpressions to work properly (list[0].Status)\n            itemDictionary(itemViewModels.reduce(function(dict, item) {\n                if(has(item.id)) {\n                    dict[item.id] = item;\n                    row[item.id] = item.inputValue;\n                }\n                return dict;\n            }, merge(initialValues || {}))); // just in case some data doesnt have a column, keep it in the item dict\n\n            // TODO: ItemDict or Row? which one is better?\n            // rowVM\n            row.items = items;\n            row.itemDictionary = itemDictionary;\n            row.mappedChildNodes = items;\n            row.editMode = rowContext.editMode;\n            row.deleteFlag = rowContext.deleteFlag;\n            row.readonly = function (bool) {\n              items().forEach(function (item) {\n                if (item.setReadonly) {\n                    item.setReadonly(bool);\n                } else if (item.readonly) {\n                  item.readonly(bool)\n                }\n              });\n            };\n\n            return row;\n        }\n\n        // generates a new row and add to list\n        function add(row, isNew) {\n            var rowVm = rowViewModel(row, isNew);\n\n            // add remove function to rowVM\n            rowVm.remove = function () {\n                rowVm.items().forEach(function (item) {\n                    if(item.dispose) {\n                        item.dispose();\n                    }\n                });\n                rows.remove(rowVm);\n            }\n\n            if (options.push) {\n                rows.push(rowVm);\n            } else {\n                rows.unshift(rowVm);\n            }\n\n\n            if(isNew === true) {\n                // auto-focus on the newly added row\n                setTimeout(function () {\n                    // need to wait for clickOff events to stop firing.\n                    rowVm.editMode(true);\n                    (rowVm.items() || []).some(function (item) {\n                        if(item.rendered() && item.hasFocus) {\n                            item.hasFocus(true);\n                            return true;\n                        }\n                    });\n                });\n            }\n        }\n\n        // returns the values of the list\n        // e.g. [{item1:'Value1',item2:'Value2'}]\n        // dontSendIfEmpty - this prevents items from getting sent in the data if that property is empty\n        // if array is empty send null\n        function getValue() {\n            var originalData = data.peek(),\n                listData = _.cloneDeep(rows().map(function(row) {\n                    var originalRowItems = row.itemDictionary.peek();\n                    return Object.keys(originalRowItems).reduce(function (dataObj, itemKey) {\n                        var item = row.itemDictionary.peek()[itemKey];\n\n                        if (item.getValue) {\n                            dataObj[item.id] = item.getValue();\n                        } else if(has(item) && item.type !== 'DELETE') {\n                            dataObj[itemKey] = item;\n                        }\n                        return dataObj;\n                    }, {});\n                }).filter(function(obj){\n                    return !(options.dontSendIfEmpty &&\n                        (!obj[options.dontSendIfEmpty] && obj[options.dontSendIfEmpty] !== 0));\n                }));\n                if (options.sendNullIfEmpty && listData.length === 0) {\n                  listData = null;\n                }\n            return listData;\n        }\n\n        // on initialization if the node already has data defined, add rows\n        // else generate the minReqiredRows\n        function initialize() {\n            //console.time('List init');\n            if (data()) {\n                rows().forEach(function(row){\n                    row.items().forEach(function(item){\n                        item.dispose && item.dispose();\n                    });\n                });\n                rows.removeAll();\n                data().forEach(function (item) {\n                    add(item, false);\n                });\n\n                //if trackDiffChanges set to true store the original data to noticeboard\n                if (node.trackDiffChanges) {\n                    noticeboard.set(node.id, data());\n                }\n            } else {\n                for (var i = 0; i < minRequiredRows; i ++) {\n                    add(null, true);\n                }\n            }\n          //  console.timeEnd('List init');\n        }\n\n        // sets value in list\n        // or re-inits if data is empty or invalid\n        function setValue(newData) {\n            // reverse the data because adding now unshifts the rows.\n            if(Array.isArray(newData) && !options.push) {\n                newData.reverse();\n            }\n            data(newData || (initialData || []));\n            initialize();\n        }\n\n        // returns last row\n        function lastRow() {\n            return rows()[rows().length-1];\n        }\n\n        // sets minrequired rows\n         if (node.validations && node.validations.required) {\n            minRequiredRows = node.validations.required === true ? 1 : node.validations.required;\n        }\n\n        // only show remove button if rows is greater than min req rows\n        showRemoveButton = computed(function () {\n            return rows().length > minRequiredRows;\n        });\n\n        // get data from data parent if exists\n        if (context.data && !options.subscribeToData) {\n            console.warn('Please make sure you get the Data from setValue or set node.subscribeToData to true! Removing data-subscribe as a default', node);\n        }\n        if (options.subscribeToData && context.data) {\n            if (context.data()[node.id]) {\n                data(context.data()[node.id]);\n            } else {\n                context.data.subscribe(function (newData) {\n                    if (newData[node.id]) {\n                        data(newData[node.id]);\n                        initialize();\n                    }\n                })\n            }\n        }\n\n        initialize();\n\n        // will \"remove\" mapped child nodes if the list is hidden\n        // this is required for validations to work properly\n        // todo: remove this workaround and implement validation on list itself\n        computed(function () {\n            if (isShown()) {\n                mappedChildNodes(rows().filter(function (row) {\n                    return !row.deleteFlag();\n                }));\n            } else {\n                mappedChildNodes([]);\n            }\n        });\n\n        if (node.infinite) {\n            rows.subscribe(function (newRows) {\n                visibleRows((newRows ||[]).slice(0,20));\n            });\n\n            scrolled = function(event) {\n                var elem = event.target,\n                    currentRows = rows();\n\n                if (elem.scrollTop > (elem.scrollHeight - elem.offsetHeight - 35)) {\n                    var seed = visibleRows().length;\n                    for (var i = 0; i < 20; i++) {\n                        visibleRows.push(currentRows[seed+i]);\n\n                        if(!currentRows[seed+i]) {\n                            // no more rows stahp\n                            break;\n                        }\n                    }\n                }\n            }\n        }\n\n\n\n        return merge(node, {\n            add: add,\n            rows: node.infinite ? visibleRows : rows,\n            allRows: rows,\n            scrolled: scrolled,\n            mappedChildNodes: mappedChildNodes,\n            isShown: isShown,\n            showRemove: showRemoveButton,\n            getValue: getValue,\n            setValue: setValue,\n            readonly: readonly,\n            deleteRows: deleteRows,\n            lastRow: lastRow,\n            setReadonly: setReadonly,\n            addButtonRendered: addButtonRendered\n        });\n    };\n"]}