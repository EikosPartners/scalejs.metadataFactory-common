{"version":3,"sources":["../../src/list/listViewModel.js"],"names":[],"mappings":"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","file":"listViewModel.js","sourcesContent":["import { observable, observableArray, computed, unwrap } from 'knockout';\r\nimport { createViewModel } from 'scalejs.metadataFactory';\r\nimport { evaluate } from 'scalejs.expression-jsep';\r\nimport noticeboard from 'scalejs.noticeboard';\r\nimport { merge, has, is } from 'scalejs';\r\nimport _ from 'lodash';\r\n\r\n    // todo: revisit comments below\r\n    // listViewModel is a component which manages a simple list\r\n    // - items - items are what are used to make up the rows in the list\r\n    // - options\r\n    // -- addRows - if false add button does not appear\r\n    // -- deleteRows - if false delete button does not appear\r\n    // -- minRequiredRows - initializes list with # of rows and wont let user delete\r\n\r\n    //TODO: Refactor Session\r\n    //- implement \"parent passes to children\" pattern for labels\r\n    //- brainstorm cleaner \"itemViewModel\" imp.\r\n    //- general clean up/renaming/documenting session\r\n    // ...add more refactor session goals here!\r\n    /**\r\n     *  list is the component to use when wanting to group items into enumerable lists.\r\n     *  There are two types of lists: responsive form lists (default) and table lists (+listAdvanced wrapper)\r\n     *  The underlying data model for a list is an array of objects.\r\n     *\r\n     * @module list\r\n     *\r\n     * @param {object} node\r\n     *  The configuration specs for the component.\r\n     * @param {string} [node.id]\r\n     *  The id of the list becomes the key in the data for all the children of the list.\r\n     *\r\n     */\r\n    let listItems = {\r\n        DELETE: del,\r\n        DELETE_FLAG: deleteFlag\r\n    };\r\n\r\n    function del(itemDef) {\r\n        var context = this;\r\n        return merge(itemDef, {\r\n            id: undefined,\r\n            template: {\r\n                name: 'list_del_template',\r\n                data: context\r\n            }\r\n        })\r\n    }\r\n\r\n    function deleteFlag(itemDef) {\r\n        var context = this;\r\n        // the id will be the propertu\r\n        // getValue - return if it was deleted or not\r\n        return context.isNew ? del.call(context, itemDef) : merge(context, {\r\n            template: 'list_del_flag_template',\r\n            getValue: function () {\r\n                return context.deleteFlag() ? \"T\" : \"F\";\r\n            },\r\n            deleteRow: function () {\r\n                context.deleteFlag(true);\r\n                if(itemDef.options && itemDef.options.clearOnDelete) {\r\n                    var item = context.itemDictionary()[itemDef.options.clearOnDelete];\r\n                    if(item && item.setValue) {\r\n                        item.setValue(0);\r\n                    }\r\n                }\r\n            }\r\n        }, itemDef)\r\n    }\r\n\r\n\r\n\r\n    export default function listViewModel(node) {\r\n        var  keyMap = node.keyMap || {},\r\n            rows = observableArray(),\r\n            options = node.options || {},\r\n            isShown = observable(true),\r\n            context = this || {},\r\n            readonly = observable((context.readonly && context.readonly()) || false), //initialize to the context's state as determined by the form generally\r\n            deleteRows = observable(options.deleteRows !== false),\r\n            minRequiredRows = 0,\r\n            showRemoveButton,\r\n            // addButtonContext = node.addButtonContext,\r\n            mappedChildNodes = observableArray(),\r\n            data = observable(node.data),\r\n            unique = {},\r\n            visibleRows = observableArray(),\r\n            scrolled,\r\n            initialData = _.cloneDeep(node.data) || [];\r\n\r\n        function setReadonly (bool) {\r\n          readonly(bool); //sets readonly state of the list\r\n          rows().forEach(function (row) { //sets readonly state of each row\r\n            row.readonly(bool)\r\n          });\r\n        }\r\n\r\n        // rowViewModel\r\n        // called on each add\r\n        // or when data is set with initial values\r\n        function rowViewModel(initialValues, isNew) {\r\n            var items = observableArray(), // observable array to hold the items in the row\r\n                itemDictionary = observable({}), // observable dictionary to hold the items and other properties\r\n                rowContext = {\r\n                    metadata: context.metadata, // reference to the parent metadata\r\n                    rows: rows,\r\n                    unique: unique,\r\n                    isNew: isNew,\r\n                    itemDictionary: itemDictionary,\r\n                    editMode: observable(false), //for styling - maybe better if called isActiveRow\r\n                    deleteFlag: observable(false)\r\n                },\r\n                row = {}, // the row itself\r\n                itemViewModels,\r\n                rowReadonly;\r\n\r\n            // initialize row readonly as the list's state\r\n            rowContext.readonly = observable(readonly());\r\n\r\n            // rowReadonly - string to run thrown expression parser to show/hide rows\r\n            if (is(options.rowReadonly, 'string')) {\r\n                rowReadonly = computed(function () {\r\n                    if (rowContext.readonly && rowContext.readonly()) {\r\n                        return true; //if readonly is true on context, then row is readonly\r\n                    }\r\n                    // else, eval the expression to determine if the row is readonly\r\n                    return evaluate(options.rowReadonly, function (id) {\r\n                        var item = itemDictionary()[id];\r\n                        if (item && item.getValue) {\r\n                            return item.getValue();\r\n                        }\r\n                    });\r\n                });\r\n            }\r\n\r\n            // can be utilized by expression parser to get error for an id\r\n            function error(id) {\r\n                var item = itemDictionary()[id];\r\n                if(item && item.inputValue && item.inputValue.error) {\r\n                    return item.inputValue.error();\r\n                }\r\n            }\r\n\r\n            // accurately calculates the index of the row in the list\r\n            rowContext.index = computed(function () {\r\n                return rows().indexOf(row);\r\n            });\r\n\r\n            // getValueById function for expression parsing\r\n            // todo. refactor this\r\n            rowContext.getValue = function (id) {\r\n               if (id === 'index') {\r\n                    return rowContext.index();\r\n                }\r\n                if (id === 'list') {\r\n                    return rows();\r\n                }\r\n                if (id === 'row') {\r\n                    return rows()[rowContext.index()];\r\n                }\r\n                if (id === 'error') {\r\n                    return error;\r\n                }\r\n                // check the item dictionary\r\n                var item = itemDictionary()[id];\r\n                if (item && item.getValue) {\r\n                    return item.getValue();\r\n                }\r\n\r\n                // if the item doesnt have getValue, return itself\r\n                if (has(item)) {\r\n                    return unwrap(item);\r\n                }\r\n\r\n                let prop = rowContext[id];\r\n\r\n                if (has(prop)) {\r\n                    return unwrap(prop);\r\n                }\r\n\r\n                return context.getValue(id);\r\n            }\r\n\r\n\r\n            itemViewModels = node.items.map(function (_item) {\r\n                var item = _.cloneDeep(_item); // deep clone the item as we might mutate it before passing to createViewModels\r\n\r\n                // add readonly computed to the item before passing it to input\r\n                // input will use the already defined observable if it exists\r\n                // but, if the input already has readonly set on it, dont get readonly from row..\r\n                if (rowReadonly && item.input && !has(item.input.readonly)) {\r\n                    item.input.readonly = rowReadonly;\r\n                }\r\n\r\n                if(item.options && item.options.unique) {\r\n                    if(!item.id) {\r\n                        console.error('Cannot set unique on item without id');\r\n                    } else if (!unique[item.id]) { //only create once\r\n                        unique[item.id] = observableArray();\r\n                    }\r\n                }\r\n\r\n                // todo - clean this up?\r\n                if (listItems[item.type]) {\r\n                    var ret = listItems[item.type].call(rowContext, item);\r\n                    if (item.visible) {\r\n                        ret.visible = computed(function () {\r\n                            return evaluate(item.visible, rowContext.getValue);\r\n                        });\r\n                    }\r\n                    return ret;\r\n                } else {\r\n                    return createViewModel.call(rowContext, item);\r\n                }\r\n            });\r\n\r\n            // if there are initial values, update the children\r\n            if (initialValues) {\r\n                itemViewModels.forEach(function(item) {\r\n                    if (initialValues[item.id]) { // allow for JSON default values don't get overwritten by server data that doesn't contain data\r\n                        item.setValue && item.setValue(initialValues[item.id]);\r\n                    }\r\n                });\r\n            }\r\n\r\n            // update items obsArr\r\n            items(itemViewModels);\r\n\r\n            // generate itemDictionary from the itemViewModels\r\n            // also add each item's inputValue directly on the row\r\n            // this is for MemberExpressions to work properly (list[0].Status)\r\n            itemDictionary(itemViewModels.reduce(function(dict, item) {\r\n                if(has(item.id)) {\r\n                    dict[item.id] = item;\r\n                    row[item.id] = item.inputValue;\r\n                }\r\n                return dict;\r\n            }, merge(initialValues || {}))); // just in case some data doesnt have a column, keep it in the item dict\r\n\r\n            // TODO: ItemDict or Row? which one is better?\r\n            // rowVM\r\n            row.items = items;\r\n            row.itemDictionary = itemDictionary;\r\n            row.mappedChildNodes = items;\r\n            row.editMode = rowContext.editMode;\r\n            row.deleteFlag = rowContext.deleteFlag;\r\n            row.readonly = function (bool) {\r\n              items().forEach(function (item) {\r\n                if (item.setReadonly) {\r\n                    item.setReadonly(bool);\r\n                } else if (item.readonly) {\r\n                  item.readonly(bool)\r\n                }\r\n              });\r\n            };\r\n\r\n            return row;\r\n        }\r\n\r\n        // generates a new row and add to list\r\n        function add(row, isNew) {\r\n            var rowVm = rowViewModel(row, isNew);\r\n\r\n            // add remove function to rowVM\r\n            rowVm.remove = function () {\r\n                rowVm.items().forEach(function (item) {\r\n                    if(item.dispose) {\r\n                        item.dispose();\r\n                    }\r\n                });\r\n                rows.remove(rowVm);\r\n            }\r\n\r\n            if (options.push) {\r\n                rows.push(rowVm);\r\n            } else {\r\n                rows.unshift(rowVm);\r\n            }\r\n\r\n\r\n            if(isNew === true) {\r\n                // auto-focus on the newly added row\r\n                setTimeout(function () {\r\n                    // need to wait for clickOff events to stop firing.\r\n                    rowVm.editMode(true);\r\n                    (rowVm.items() || []).some(function (item) {\r\n                        if(item.rendered() && item.hasFocus) {\r\n                            item.hasFocus(true);\r\n                            return true;\r\n                        }\r\n                    });\r\n                });\r\n            }\r\n        }\r\n\r\n        // returns the values of the list\r\n        // e.g. [{item1:'Value1',item2:'Value2'}]\r\n        // dontSendIfEmpty - this prevents items from getting sent in the data if that property is empty\r\n        // if array is empty send null\r\n        function getValue() {\r\n            var originalData = data.peek(),\r\n                listData = _.cloneDeep(rows().map(function(row) {\r\n                    var originalRowItems = row.itemDictionary.peek();\r\n                    return Object.keys(originalRowItems).reduce(function (dataObj, itemKey) {\r\n                        var item = row.itemDictionary.peek()[itemKey];\r\n\r\n                        if (item.getValue) {\r\n                            dataObj[item.id] = item.getValue();\r\n                        } else if(has(item) && item.type !== 'DELETE') {\r\n                            dataObj[itemKey] = item;\r\n                        }\r\n                        return dataObj;\r\n                    }, {});\r\n                }).filter(function(obj){\r\n                    return !(options.dontSendIfEmpty &&\r\n                        (!obj[options.dontSendIfEmpty] && obj[options.dontSendIfEmpty] !== 0));\r\n                }));\r\n                if (options.sendNullIfEmpty && listData.length === 0) {\r\n                  listData = null;\r\n                }\r\n            return listData;\r\n        }\r\n\r\n        // on initialization if the node already has data defined, add rows\r\n        // else generate the minReqiredRows\r\n        function initialize() {\r\n            //console.time('List init');\r\n            if (data()) {\r\n                rows().forEach(function(row){\r\n                    row.items().forEach(function(item){\r\n                        item.dispose && item.dispose();\r\n                    });\r\n                });\r\n                rows.removeAll();\r\n                data().forEach(function (item) {\r\n                    add(item, false);\r\n                });\r\n\r\n                //if trackDiffChanges set to true store the original data to noticeboard\r\n                if (node.trackDiffChanges) {\r\n                    noticeboard.set(node.id, data());\r\n                }\r\n            } else {\r\n                for (var i = 0; i < minRequiredRows; i ++) {\r\n                    add(null, true);\r\n                }\r\n            }\r\n          //  console.timeEnd('List init');\r\n        }\r\n\r\n        // sets value in list\r\n        // or re-inits if data is empty or invalid\r\n        function setValue(newData) {\r\n            // reverse the data because adding now unshifts the rows.\r\n            if(Array.isArray(newData.value) && !options.push) {\r\n                newData.value.reverse();\r\n            }\r\n            data(newData.value || (initialData || []));\r\n            initialize();\r\n        }\r\n\r\n        // returns last row\r\n        function lastRow() {\r\n            return rows()[rows().length-1];\r\n        }\r\n\r\n        // sets minrequired rows\r\n         if (node.validations && node.validations.required) {\r\n            minRequiredRows = node.validations.required === true ? 1 : node.validations.required;\r\n        }\r\n\r\n        // only show remove button if rows is greater than min req rows\r\n        showRemoveButton = computed(function () {\r\n            return rows().length > minRequiredRows;\r\n        });\r\n\r\n        // get data from data parent if exists\r\n        if (context.data && !options.subscribeToData) {\r\n            console.warn('Please make sure you get the Data from form and setValue or set node.subscribeToData to true! Removing data-subscribe as a default', node);\r\n        }\r\n        if (options.subscribeToData && context.data) {\r\n            if (context.data()[node.id]) {\r\n                data(context.data()[node.id]);\r\n            } else {\r\n                context.data.subscribe(function (newData) {\r\n                    if (newData[node.id]) {\r\n                        data(newData[node.id]);\r\n                        initialize();\r\n                    }\r\n                })\r\n            }\r\n        }\r\n\r\n        initialize();\r\n\r\n        // will \"remove\" mapped child nodes if the list is hidden\r\n        // this is required for validations to work properly\r\n        // todo: remove this workaround and implement validation on list itself\r\n        computed(function () {\r\n            if (isShown()) {\r\n                mappedChildNodes(rows().filter(function (row) {\r\n                    return !row.deleteFlag();\r\n                }));\r\n            } else {\r\n                mappedChildNodes([]);\r\n            }\r\n        });\r\n\r\n        if (node.infinite) {\r\n            rows.subscribe(function (newRows) {\r\n                visibleRows((newRows ||[]).slice(0,20));\r\n            });\r\n\r\n            scrolled = function(event) {\r\n                var elem = event.target,\r\n                    currentRows = rows();\r\n\r\n                if (elem.scrollTop > (elem.scrollHeight - elem.offsetHeight - 35)) {\r\n                    var seed = visibleRows().length;\r\n                    for (var i = 0; i < 20; i++) {\r\n                        visibleRows.push(currentRows[seed+i]);\r\n\r\n                        if(!currentRows[seed+i]) {\r\n                            // no more rows stahp\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n\r\n        return merge(node, {\r\n            add: add,\r\n            rows: node.infinite ? visibleRows : rows,\r\n            allRows: rows,\r\n            scrolled: scrolled,\r\n            mappedChildNodes: mappedChildNodes,\r\n            isShown: isShown,\r\n            showRemove: showRemoveButton,\r\n            getValue: getValue,\r\n            setValue: setValue,\r\n            readonly: readonly,\r\n            deleteRows: deleteRows,\r\n            lastRow: lastRow,\r\n            setReadonly: setReadonly\r\n        });\r\n    };\r\n"]}