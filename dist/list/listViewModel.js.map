{"version":3,"sources":["../../src/list/listViewModel.js"],"names":[],"mappings":"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","file":"listViewModel.js","sourcesContent":["import { observable, observableArray, computed, unwrap } from 'knockout';\nimport { createViewModel } from 'scalejs.metadataFactory';\nimport { evaluate } from 'scalejs.expression-jsep';\nimport * as noticeboard from 'scalejs.noticeboard';\nimport { merge, has, is } from 'scalejs';\nimport _ from 'lodash';\n\n    // todo: revisit comments below\n    // listViewModel is a component which manages a simple list\n    // - items - items are what are used to make up the rows in the list\n    // - options\n    // -- addRows - if false add button does not appear\n    // -- deleteRows - if false delete button does not appear\n    // -- minRequiredRows - initializes list with # of rows and wont let user delete\n\n    //TODO: Refactor Session\n    //- implement \"parent passes to children\" pattern for labels\n    //- brainstorm cleaner \"itemViewModel\" imp.\n    //- general clean up/renaming/documenting session\n    // ...add more refactor session goals here!\n    /**\n     *  list is the component to use when wanting to group items into enumerable lists.\n     *  There are two types of lists: responsive form lists (default) and table lists (+listAdvanced wrapper)\n     *  The underlying data model for a list is an array of objects.\n     *\n     * @module list\n     *\n     * @param {object} node\n     *  The configuration specs for the component.\n     * @param {string} [node.id]\n     *  The id of the list becomes the key in the data for all the children of the list.\n     *\n     */\n    let listItems = {\n        DELETE: del,\n        DELETE_FLAG: deleteFlag\n    };\n\n    function del(itemDef) {\n        var context = this;\n        return merge(itemDef, {\n            id: undefined,\n            template: {\n                name: 'list_del_template',\n                data: context\n            }\n        })\n    }\n\n    function deleteFlag(itemDef) {\n        var context = this;\n        // the id will be the propertu\n        // getValue - return if it was deleted or not\n        return context.isNew ? del.call(context, itemDef) : merge(context, {\n            template: 'list_del_flag_template',\n            getValue: function () {\n                return context.deleteFlag() ? \"T\" : \"F\";\n            },\n            deleteRow: function () {\n                context.deleteFlag(true);\n                if(itemDef.options && itemDef.options.clearOnDelete) {\n                    var item = context.itemDictionary()[itemDef.options.clearOnDelete];\n                    if(item && item.setValue) {\n                        item.setValue(0);\n                    }\n                }\n            }\n        }, itemDef)\n    }\n\n\n\n    export default function listViewModel(node) {\n        var  keyMap = node.keyMap || {},\n            rows = observableArray(),\n            options = node.options || {},\n            isShown = observable(true),\n            context = this || {},\n            readonly = observable((context.readonly && context.readonly()) || false), //initialize to the context's state as determined by the form generally\n            deleteRows = observable(options.deleteRows !== false),\n            minRequiredRows = 0,\n            showRemoveButton,\n            // addButtonContext = node.addButtonContext,\n            mappedChildNodes = observableArray(),\n            data = observable(node.data),\n            unique = {},\n            visibleRows = observableArray(),\n            scrolled,\n            initialData = _.cloneDeep(node.data) || [];\n\n        function setReadonly (bool) {\n          readonly(bool); //sets readonly state of the list\n          rows().forEach(function (row) { //sets readonly state of each row\n            row.readonly(bool)\n          });\n        }\n\n        // rowViewModel\n        // called on each add\n        // or when data is set with initial values\n        function rowViewModel(initialValues, isNew) {\n            var items = observableArray(), // observable array to hold the items in the row\n                itemDictionary = observable({}), // observable dictionary to hold the items and other properties\n                rowContext = {\n                    metadata: context.metadata, // reference to the parent metadata\n                    rows: rows,\n                    unique: unique,\n                    isNew: isNew,\n                    itemDictionary: itemDictionary,\n                    editMode: observable(false), //for styling - maybe better if called isActiveRow\n                    deleteFlag: observable(false)\n                },\n                row = {}, // the row itself\n                itemViewModels,\n                rowReadonly;\n\n            // initialize row readonly as the list's state\n            rowContext.readonly = observable(readonly());\n\n            // rowReadonly - string to run thrown expression parser to show/hide rows\n            if (is(options.rowReadonly, 'string')) {\n                rowReadonly = computed(function () {\n                    if (rowContext.readonly && rowContext.readonly()) {\n                        return true; //if readonly is true on context, then row is readonly\n                    }\n                    // else, eval the expression to determine if the row is readonly\n                    return evaluate(options.rowReadonly, function (id) {\n                        var item = itemDictionary()[id];\n                        if (item && item.getValue) {\n                            return item.getValue();\n                        }\n                    });\n                });\n            }\n\n            // can be utilized by expression parser to get error for an id\n            function error(id) {\n                var item = itemDictionary()[id];\n                if(item && item.inputValue && item.inputValue.error) {\n                    return item.inputValue.error();\n                }\n            }\n\n            // accurately calculates the index of the row in the list\n            rowContext.index = computed(function () {\n                return rows().indexOf(row);\n            });\n\n            // getValueById function for expression parsing\n            // todo. refactor this\n            rowContext.getValue = function (id) {\n               if (id === 'index') {\n                    return rowContext.index();\n                }\n                if (id === 'list') {\n                    return rows();\n                }\n                if (id === 'row') {\n                    return rows()[rowContext.index()];\n                }\n                if (id === 'error') {\n                    return error;\n                }\n                // check the item dictionary\n                var item = itemDictionary()[id];\n                if (item && item.getValue) {\n                    return item.getValue();\n                }\n\n                // if the item doesnt have getValue, return itself\n                if (has(item)) {\n                    return unwrap(item);\n                }\n\n                let prop = rowContext[id];\n\n                if (has(prop)) {\n                    return unwrap(prop);\n                }\n\n                return context.getValue(id);\n            }\n\n\n            itemViewModels = node.items.map(function (_item) {\n                var item = _.cloneDeep(_item); // deep clone the item as we might mutate it before passing to createViewModels\n\n                // add readonly computed to the item before passing it to input\n                // input will use the already defined observable if it exists\n                // but, if the input already has readonly set on it, dont get readonly from row..\n                if (rowReadonly && item.input && !has(item.input.readonly)) {\n                    item.input.readonly = rowReadonly;\n                }\n\n                if(item.options && item.options.unique) {\n                    if(!item.id) {\n                        console.error('Cannot set unique on item without id');\n                    } else if (!unique[item.id]) { //only create once\n                        unique[item.id] = observableArray();\n                    }\n                }\n\n                // todo - clean this up?\n                if (listItems[item.type]) {\n                    var ret = listItems[item.type].call(rowContext, item);\n                    if (item.visible) {\n                        ret.visible = computed(function () {\n                            return evaluate(item.visible, rowContext.getValue);\n                        });\n                    }\n                    return ret;\n                } else {\n                    return createViewModel.call(rowContext, item);\n                }\n            });\n\n            // if there are initial values, update the children\n            if (initialValues) {\n                itemViewModels.forEach(function(item) {\n                    if (initialValues[item.id]) { // allow for JSON default values don't get overwritten by server data that doesn't contain data\n                        item.setValue && item.setValue(initialValues[item.id]);\n                    }\n                });\n            }\n\n            // update items obsArr\n            items(itemViewModels);\n\n            // generate itemDictionary from the itemViewModels\n            // also add each item's inputValue directly on the row\n            // this is for MemberExpressions to work properly (list[0].Status)\n            itemDictionary(itemViewModels.reduce(function(dict, item) {\n                if(has(item.id)) {\n                    dict[item.id] = item;\n                    row[item.id] = item.inputValue;\n                }\n                return dict;\n            }, merge(initialValues || {}))); // just in case some data doesnt have a column, keep it in the item dict\n\n            // TODO: ItemDict or Row? which one is better?\n            // rowVM\n            row.items = items;\n            row.itemDictionary = itemDictionary;\n            row.mappedChildNodes = items;\n            row.editMode = rowContext.editMode;\n            row.deleteFlag = rowContext.deleteFlag;\n            row.readonly = function (bool) {\n              items().forEach(function (item) {\n                if (item.setReadonly) {\n                    item.setReadonly(bool);\n                } else if (item.readonly) {\n                  item.readonly(bool)\n                }\n              });\n            };\n\n            return row;\n        }\n\n        // generates a new row and add to list\n        function add(row, isNew) {\n            var rowVm = rowViewModel(row, isNew);\n\n            // add remove function to rowVM\n            rowVm.remove = function () {\n                rowVm.items().forEach(function (item) {\n                    if(item.dispose) {\n                        item.dispose();\n                    }\n                });\n                rows.remove(rowVm);\n            }\n\n            if (options.push) {\n                rows.push(rowVm);\n            } else {\n                rows.unshift(rowVm);\n            }\n\n\n            if(isNew === true) {\n                // auto-focus on the newly added row\n                setTimeout(function () {\n                    // need to wait for clickOff events to stop firing.\n                    rowVm.editMode(true);\n                    (rowVm.items() || []).some(function (item) {\n                        if(item.rendered() && item.hasFocus) {\n                            item.hasFocus(true);\n                            return true;\n                        }\n                    });\n                });\n            }\n        }\n\n        // returns the values of the list\n        // e.g. [{item1:'Value1',item2:'Value2'}]\n        // dontSendIfEmpty - this prevents items from getting sent in the data if that property is empty\n        // if array is empty send null\n        function getValue() {\n            var originalData = data.peek(),\n                listData = _.cloneDeep(rows().map(function(row) {\n                    var originalRowItems = row.itemDictionary.peek();\n                    return Object.keys(originalRowItems).reduce(function (dataObj, itemKey) {\n                        var item = row.itemDictionary.peek()[itemKey];\n\n                        if (item.getValue) {\n                            dataObj[item.id] = item.getValue();\n                        } else if(has(item) && item.type !== 'DELETE') {\n                            dataObj[itemKey] = item;\n                        }\n                        return dataObj;\n                    }, {});\n                }).filter(function(obj){\n                    return !(options.dontSendIfEmpty &&\n                        (!obj[options.dontSendIfEmpty] && obj[options.dontSendIfEmpty] !== 0));\n                }));\n                if (options.sendNullIfEmpty && listData.length === 0) {\n                  listData = null;\n                }\n            return listData;\n        }\n\n        // on initialization if the node already has data defined, add rows\n        // else generate the minReqiredRows\n        function initialize() {\n            //console.time('List init');\n            if (data()) {\n                rows().forEach(function(row){\n                    row.items().forEach(function(item){\n                        item.dispose && item.dispose();\n                    });\n                });\n                rows.removeAll();\n                data().forEach(function (item) {\n                    add(item, false);\n                });\n\n                //if trackDiffChanges set to true store the original data to noticeboard\n                if (node.trackDiffChanges) {\n                    noticeboard.set(node.id, data());\n                }\n            } else {\n                for (var i = 0; i < minRequiredRows; i ++) {\n                    add(null, true);\n                }\n            }\n          //  console.timeEnd('List init');\n        }\n\n        // sets value in list\n        // or re-inits if data is empty or invalid\n        function setValue(newData) {\n            // reverse the data because adding now unshifts the rows.\n            if(Array.isArray(newData.value) && !options.push) {\n                newData.value.reverse();\n            }\n            data(newData.value || (initialData || []));\n            initialize();\n        }\n\n        // returns last row\n        function lastRow() {\n            return rows()[rows().length-1];\n        }\n\n        // sets minrequired rows\n         if (node.validations && node.validations.required) {\n            minRequiredRows = node.validations.required === true ? 1 : node.validations.required;\n        }\n\n        // only show remove button if rows is greater than min req rows\n        showRemoveButton = computed(function () {\n            return rows().length > minRequiredRows;\n        });\n\n        // get data from data parent if exists\n        if (context.data && !options.subscribeToData) {\n            console.warn('Please make sure you get the Data from form and setValue or set node.subscribeToData to true! Removing data-subscribe as a default', node);\n        }\n        if (options.subscribeToData && context.data) {\n            if (context.data()[node.id]) {\n                data(context.data()[node.id]);\n            } else {\n                context.data.subscribe(function (newData) {\n                    if (newData[node.id]) {\n                        data(newData[node.id]);\n                        initialize();\n                    }\n                })\n            }\n        }\n\n        initialize();\n\n        // will \"remove\" mapped child nodes if the list is hidden\n        // this is required for validations to work properly\n        // todo: remove this workaround and implement validation on list itself\n        computed(function () {\n            if (isShown()) {\n                mappedChildNodes(rows().filter(function (row) {\n                    return !row.deleteFlag();\n                }));\n            } else {\n                mappedChildNodes([]);\n            }\n        });\n\n        if (node.infinite) {\n            rows.subscribe(function (newRows) {\n                visibleRows((newRows ||[]).slice(0,20));\n            });\n\n            scrolled = function(event) {\n                var elem = event.target,\n                    currentRows = rows();\n\n                if (elem.scrollTop > (elem.scrollHeight - elem.offsetHeight - 35)) {\n                    var seed = visibleRows().length;\n                    for (var i = 0; i < 20; i++) {\n                        visibleRows.push(currentRows[seed+i]);\n\n                        if(!currentRows[seed+i]) {\n                            // no more rows stahp\n                            break;\n                        }\n                    }\n                }\n            }\n        }\n\n\n\n        return merge(node, {\n            add: add,\n            rows: node.infinite ? visibleRows : rows,\n            allRows: rows,\n            scrolled: scrolled,\n            mappedChildNodes: mappedChildNodes,\n            isShown: isShown,\n            showRemove: showRemoveButton,\n            getValue: getValue,\n            setValue: setValue,\n            readonly: readonly,\n            deleteRows: deleteRows,\n            lastRow: lastRow,\n            setReadonly: setReadonly\n        });\n    };\n"]}