{"version":3,"sources":["../../src/menu/menuViewModel.js"],"names":["node","keyMap","context","base","call","type","mappedChildNodes","accordion","mapToAccordion","data","sections","map","section","title","unzip","zipped","children","isShown","options","trueAccordion","openByDefault","template","mapWorkflow","workflow","resultsKey","openPanel","openFirst","firstSection","visible","dataSourceEndpoint","subscribe"],"mappings":";;;;;;;;kBAMmB,UAAUA,IAAV,EAAgB;AAC3B,QAAIC,SAASD,KAAKC,MAAL,IAAe,EAA5B;AAAA,QACIC,UAAU,IADd;AAAA,QAEIC,OAAO,yBAAgBC,IAAhB,CAAqB,IAArB,EAA2B,qBAAMJ,IAAN,EAAY,EAAEK,MAAM,UAAR,EAAZ,CAA3B,CAFX;AAAA,QAGIC,mBAAmB,gCAHvB;AAAA,QAIIC,SAJJ;;AAMA,aAASC,cAAT,CAAwBC,IAAxB,EAA8B;AAC1B,YAAI,CAACA,KAAKC,QAAV,EAAoB;AAChB,mBAAO;AACH,wBAAQ,UADL;AAEH,4BAAY;AAFT,aAAP;AAIH;;AAEG,qBAASD,KAAKC,QAAL,CAAcC,GAAd,CAAkB,mBAAW;AAClC,mBAAO,CACHC,QAAQC,KADL,EAEHL,eAAeI,OAAf,CAFG,CAAP;AAIH,SALQ,CAAT;AAAA,sBAMuB,iBAAEE,KAAF,CAAQC,MAAR,CANvB;AAAA;AAAA,YAMCL,QAND;AAAA,YAMWM,QANX;;;AAQJ,eAAO;AACHX,kBAAM,WADH;AAEHY,qBAAS,0BAAW,IAAX,CAFN;AAGH;AACA;AACAC,qBAAS;AACLC,+BAAe,IADV;AAELC,+BAAe;AAFV,aALN;AASHC,sBAAU,gBATP;AAUHX,8BAVG;AAWHM;AAXG,SAAP;AAaH;;AAED,aAASM,WAAT,CAAqBb,IAArB,EAA2B;AACvB,YAAIc,WAAW,mBAAId,IAAJ,EAAUR,OAAOuB,UAAP,IAAqB,EAA/B,EAAmCf,IAAnC,CAAf;AACA;AACAF,oBAAY,yBAAgBH,IAAhB,CAAqBF,OAArB,EAA8BM,eAAee,QAAf,CAA9B,CAAZ;AACAjB,yBAAiB,CAACC,SAAD,CAAjB;;AAEA,YAAI,CAACgB,SAASE,SAAd,EAAyB;AACrBC,sBAAUnB,SAAV;AACH;AACJ;;AAED,aAASmB,SAAT,CAAmBnB,SAAnB,EAA8B;AAC1B,YAAIoB,eAAepB,UAAUG,QAAV,IAAsBH,UAAUG,QAAV,CAAmB,CAAnB,CAAzC;AACA,YAAG,CAACiB,YAAJ,EAAkB;AACd,mBADc,CACN;AACX;AACDA,qBAAaC,OAAb,CAAqB,IAArB;AACAF,kBAAUC,YAAV;AACH;;AAED,QAAG3B,KAAKS,IAAR,EAAc;AACV;AACAa,oBAAYnB,KAAKM,IAAL,EAAZ;AACH,KAHD,MAGO,IAAIT,KAAK6B,kBAAT,EAA6B;AAChC;AACA1B,aAAKM,IAAL,CAAUqB,SAAV,CAAoB,gBAAQ;AACxBR,wBAAYb,IAAZ;AACH,SAFD;AAGH;;AAED,WAAO,qBAAMT,IAAN,EAAY;AACfM;AADe,KAAZ,CAAP;AAGH,C;;AA7EL;;AACA;;AACA;;AACA;;AACA;;;;;;AAyEK","file":"menuViewModel.js","sourcesContent":["import { createViewModels, createViewModel } from 'scalejs.metadataFactory';\r\nimport { unwrap, computed, observable, observableArray } from 'knockout';\r\nimport { receive } from 'scalejs.messagebus';\r\nimport { merge, get } from 'scalejs';\r\nimport _ from 'lodash';\r\n\r\n    export default function (node) {\r\n        var keyMap = node.keyMap || {},\r\n            context = this,\r\n            base = createViewModel.call(this, merge(node, { type: 'template' })),\r\n            mappedChildNodes = observableArray(),\r\n            accordion;\r\n\r\n        function mapToAccordion(data) {\r\n            if (!data.sections) {\r\n                return {\r\n                    \"type\": \"template\",\r\n                    \"template\": \"empty_panel\",\r\n                }\r\n            }\r\n\r\n            let zipped = data.sections.map(section => {\r\n                    return [\r\n                        section.title,\r\n                        mapToAccordion(section)\r\n                    ]\r\n                }),\r\n                [sections, children] = _.unzip(zipped);\r\n            \r\n            return {\r\n                type: 'accordion',\r\n                isShown: observable(true),\r\n                // keep all menu items \"closed\" by default\r\n                // only allow one open menu at a time\r\n                options: {\r\n                    trueAccordion: true,\r\n                    openByDefault: false\r\n                },\r\n                template: 'menu_accordion',\r\n                sections,\r\n                children\r\n            }\r\n        }\r\n\r\n        function mapWorkflow(data) {\r\n            var workflow = get(data, keyMap.resultsKey || '', data);\r\n            // data will be converted to metadata in order to render accordions\r\n            accordion = createViewModel.call(context, mapToAccordion(workflow))\r\n            mappedChildNodes([accordion]);\r\n            \r\n            if (!workflow.openPanel) {\r\n                openFirst(accordion);\r\n            }\r\n        }        \r\n\r\n        function openFirst(accordion) {\r\n            let firstSection = accordion.sections && accordion.sections[0];\r\n            if(!firstSection) {\r\n                return; // all done opening accordions\r\n            }\r\n            firstSection.visible(true);\r\n            openFirst(firstSection);\r\n        }\r\n\r\n        if(node.data) {            \r\n            // data loaded synchronously \r\n            mapWorkflow(base.data());\r\n        } else if (node.dataSourceEndpoint) {\r\n            // data loaded asynchronously\r\n            base.data.subscribe(data => {\r\n                mapWorkflow(data);\r\n            });\r\n        }\r\n        \r\n        return merge(node, {\r\n            mappedChildNodes\r\n        });\r\n    };\r\n"]}