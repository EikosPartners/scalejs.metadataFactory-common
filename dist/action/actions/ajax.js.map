{"version":3,"sources":["../../../src/action/actions/ajax.js"],"names":[],"mappings":"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","file":"ajax.js","sourcesContent":["import { createViewModel } from 'scalejs.metadataFactory';\r\nimport { registerActions } from '../actionModule';\r\nimport { getCurrent } from 'scalejs.navigation';\r\nimport { get, is, has, merge } from 'scalejs';\r\nimport noticeboard  from 'scalejs.noticeboard';\r\nimport dataservice from 'dataservice';\r\nimport ko from 'knockout';\r\nimport mustache from 'mustache';\r\nimport _ from 'lodash';\r\n\r\nfunction renderParams(params, data) {\r\n    let ret = params;\r\n    try {\r\n        ret = JSON.parse(\r\n            mustache.render(JSON.stringify(params), data)\r\n        );\r\n    } catch (ex) {\r\n        console.error('Unable to JSON parse/stringify params', ex);\r\n    }\r\n    return ret;\r\n}\r\n\r\n\r\nfunction ajax(options, args) {\r\n    let context = this,\r\n        data = context.data && ko.unwrap(context.data),\r\n        target = _.cloneDeep(options.target), // to prevent mutations to underlying object\r\n        optionData = options.data || {},\r\n        // todo: is dictionary reliable?\r\n        renderDataObject =  merge(data, optionData, getCurrent().query, ko.toJS(noticeboard.dictionary())), \r\n        uri = mustache.render(options.target.uri, renderDataObject), \r\n        callback = args && args.callback,\r\n        nextAction;\r\n\r\n    if (target.data) {\r\n         //will skip rest of else if's if we have target.data\r\n        target.data = target.data;\r\n    } else if (options.sendDataFromKey) {\r\n        target.data = data[options.sendDataFromKey];\r\n    } else if (Array.isArray(options.sendDataKeys)) {\r\n        target.data = options.sendDataKeys.reduce(function(o, k) {\r\n            let receiverKey = k, supplierKey = k, value;\r\n            if(is(k, 'object')) {\r\n                Object.keys(k).forEach(function (key) {\r\n                    receiverKey = key;\r\n                    supplierKey = k[key];\r\n                });\r\n            }\r\n\r\n            if(!has(data[supplierKey])) {\r\n                console.warn('Data key missing from data', supplierKey);\r\n                o[receiverKey] = null;\r\n                return o;\r\n            }\r\n\r\n            value = data[supplierKey];\r\n            if(typeof value === 'string') { value = value.trim(); }\r\n            o[receiverKey] = value;\r\n            return o;\r\n        }, {});\r\n    } else if (options.dataAndResults) {\r\n        // grabbing results from a previous ajaxAction\r\n        target.data = {\r\n            data: data,\r\n            results: options.results\r\n        };\r\n    } else if (get(options, 'target.options.type') === 'POST' || get(options, 'target.options.type') === 'PUT') {\r\n        target.data = data;\r\n    } else {\r\n        target.data = {};\r\n    }\r\n    \r\n    if (options.dataAndResults) {\r\n        // grabbing results from a previous ajaxAction\r\n        // combining with data from above\r\n        target.data = {\r\n            data: target.data,\r\n            results: options.results\r\n        };\r\n    }\r\n\r\n    if (options.params) {\r\n        console.log('Using render params feature in ajax:', options);\r\n        target.data = renderParams(options.params, renderDataObject);\r\n    }\r\n\r\n    nextAction =  function (error, results) {\r\n        let opts = options ? _.cloneDeep(options) : {},\r\n            err = error ? error : null;\r\n\r\n        ((err ? opts.errorActions : opts.nextActions) || []).forEach(function (item) {\r\n            if (err && opts.errorActions){\r\n                opts.errorActions.forEach(function(errorAction){\r\n                    if (errorAction.options.message && error.message) {\r\n                        errorAction.options.message = error.message;\r\n                    }\r\n                });\r\n            }\r\n\r\n            // get the results of the request and push\r\n            let response = {\r\n                request: options.target,\r\n                error: error,\r\n                results: results\r\n            };\r\n\r\n            item.options = merge(response, item.options);\r\n            createViewModel.call(context, item).action();\r\n        });\r\n\r\n        if (callback) {\r\n            callback.apply(null, arguments);\r\n        }\r\n    };\r\n\r\n    dataservice.ajax(merge(target, { uri: uri }), nextAction);\r\n}\r\n\r\nregisterActions({ajax});"]}