{"version":3,"sources":["../../src/template/templateViewModel.js"],"names":[],"mappings":";;;;;kBAOwB,iB;;AAPxB;;AAEA;;AACA;;AACA;;AACA;;AAEe,SAAS,iBAAT,CAA2B,IAA3B,EAAiC;AAC5C,QAAI,OAAO,0BAAW,KAAK,cAAL,CAAoB,MAApB,IAA8B,KAAK,IAAnC,GAA0C,EAArD,CAAX;AAAA,QAAqE;AACjE,cAAU,KAAK,OAAL,IAAgB,KAAK,OAAL,CAAa,aAA7B,GAA6C,EAAE,UAAU,EAAZ,EAAgB,MAAM,IAAtB,EAA7C,GAA4E,IAD1F;AAAA,QAEI,kBAAkB,yBAAuB,IAAvB,CAA4B,OAA5B,CAFtB;AAAA,QAE4D;AACxD,uBAAmB,0BAAwB,IAAxB,CAA6B,OAA7B,CAHvB;AAAA,QAG8D;AAC1D,0BAAsB,uCAJ1B;AAAA,QAKI,qBAAqB,KAAK,kBAL9B;AAAA,QAMI,UAAU,0BAAW,KAAK,OAAL,KAAiB,KAA5B,CANd;AAAA,QAOI,aAAa,uBAAU,KAAK,MAAf,CAPjB;AAAA,QAQI,aAAa,KARjB;AAAA,QASI,gBATJ;AAAA,QAUI,MAVJ;;AAcA,aAAS,SAAT,GAAqB;AACjB,YAAI,KAAK,KAAL,IAAc,UAAlB,EAA8B;AAC1B;AACH;;AAED,wBAAgB;AACZ,oBAAQ,QADI;AAEZ,0BAAc,MAFF;AAGZ,uBAAW;AAHC,SAAhB,EAIG,MAJH,CAIU;AACN,sBAAU,kBAAU,GAAV,EAAe,OAAf,EAAwB;AAC9B,oBAAI,GAAJ,EAAS;AACL,4BAAQ,GAAR,CAAY,oBAAZ,EAAkC,GAAlC;AACA,yBAAK,GAAL;AACA;AACH;AACD,qBAAK,OAAL;AACA,6BAAa,IAAb;AACH;AATK,SAJV;AAeH;;AAED,QAAI,KAAK,QAAL,IAAiB,CAAC,oBAAoB,KAAK,QAAzB,CAAtB,EAA0D;AACtD,gBAAQ,KAAR,CAAc,0BAAd,EAA0C,KAAK,QAA/C;AACA,aAAK,QAAL,GAAgB,2BAAhB;AACH;;AAED,uBAAmB,iBAAiB,KAAK,QAAL,IAAiB,EAAlC,CAAnB;;AAEA,QAAI,UAAJ,EAAgB;AACZ,iBAAS,gBAAgB,UAAhB,CAAT;AACH,KAFD,MAEO;AACH,iBAAS,EAAE,QAAQ,kBAAY,CAAG,CAAzB,EAAT;AACH;;AAED,QAAI,KAAK,kBAAT,EAA6B;;AAEzB,YAAI,mBAAmB,IAAnB,KAA4B,QAAhC,EAA0C;AAC1C,oBAAQ,GAAR,2HACkE,IADlE;AAEI,iCAAqB,mBAAmB,OAAxC;AACH;;AAED,YAAI,CAAC,KAAK,QAAV,EAAoB;AAChB;AACH;AACJ;;AAED,WAAO,qBAAM,IAAN,EAAY;AACf,0BAAkB,gBADH;AAEf,mBAAW,SAFI;AAGf,gBAAQ,MAHO;AAIf,cAAM,IAJS;AAKf,iBAAS,OALM;AAMf,iBAAS;AANM,KAAZ,CAAP;AAQH","file":"templateViewModel.js","sourcesContent":["import { createViewModel as createViewModelUnbound,\r\n    createViewModels as createViewModelsUnbound } from 'scalejs.metadataFactory'\r\nimport { getRegisteredTemplates } from 'scalejs.mvvm'\r\nimport { cloneDeep } from 'lodash';\r\nimport { observable } from 'knockout';\r\nimport { merge } from 'scalejs';\r\n\r\nexport default function templateViewModel(node) {\r\n    var data = observable(node.hasOwnProperty('data') ? node.data : {}), // ability to override initial data\r\n        context = node.options && node.options.createContext ? { metadata: [], data: data } : this,\r\n        createViewModel = createViewModelUnbound.bind(context), // passes context\r\n        createViewModels = createViewModelsUnbound.bind(context), // passes context        \r\n        registeredTemplates = getRegisteredTemplates(),\r\n        dataSourceEndpoint = node.dataSourceEndpoint,\r\n        isShown = observable(node.visible !== false),\r\n        actionNode = cloneDeep(node.action),        \r\n        dataLoaded = false,\r\n        mappedChildNodes,\r\n        action;\r\n    \r\n\r\n\r\n    function fetchData() {\r\n        if (node.cache && dataLoaded) {\r\n            return;\r\n        }\r\n\r\n        createViewModel({\r\n            \"type\": \"action\",\r\n            \"actionType\": \"ajax\",\r\n            \"options\": dataSourceEndpoint\r\n        }).action({\r\n            callback: function (err, results) {\r\n                if (err) {\r\n                    console.log('ajax request error', err);\r\n                    data(err);\r\n                    return;\r\n                }\r\n                data(results);\r\n                dataLoaded = true;\r\n            }\r\n        });\r\n    }\r\n\r\n    if (node.template && !registeredTemplates[node.template]) {\r\n        console.error('Template not registered ', node.template);\r\n        node.template = 'metadata_default_template';\r\n    }\r\n\r\n    mappedChildNodes = createViewModels(node.children || []);\r\n\r\n    if (actionNode) {\r\n        action = createViewModel(actionNode);\r\n    } else {\r\n        action = { action: function () { } };\r\n    }\r\n\r\n    if (node.dataSourceEndpoint) {\r\n        \r\n        if (dataSourceEndpoint.type === 'action') {\r\n        console.log(`[templateVM] - template has been upgraded to \r\n            support \"options\" as a dataSourceEndpoint instead of action`, node);\r\n            dataSourceEndpoint = dataSourceEndpoint.options;\r\n        }\r\n\r\n        if (!node.lazyLoad) {\r\n            fetchData();\r\n        }\r\n    }\r\n\r\n    return merge(node, {\r\n        mappedChildNodes: mappedChildNodes,\r\n        fetchData: fetchData,\r\n        action: action,\r\n        data: data,\r\n        isShown: isShown,\r\n        context: this\r\n    });\r\n}\r\n"]}