{"version":3,"sources":["../../src/validations/validationsViewModel.js"],"names":[],"mappings":";;;;;kBAIwB,oB;;AAJxB;;;;AACA;;AACA;;;;AAEe,SAAS,oBAAT,CAA8B,IAA9B,EAAoC;AAC/C,QAAI,SAAS,mBAAG,MAAhB;AAAA,QACI,WAAW,mBAAG,QADlB;AAAA,QAEI,OAAO,EAFX;AAAA,QAGI,kBAHJ;AAAA,QAII,wBAJJ;AAAA,QAKI,yBAAyB,mBAAG,UAAH,CAAc,IAAd,CAL7B;AAAA,QAMI,UAAU,IANd;;AAQA,SAAK,IAAL,CAAU,uBAAQ,QAAQ,EAAR,GAAa,WAArB,EAAkC,UAAU,SAAV,EAAqB;AAC7D,oBAAY,UAAU,EAAE,MAAF,CAAS,QAAQ,UAAR,EAAT,CAAV,CAAZ;AACA,YAAI,CAAC,SAAL,EAAgB;AACZ,yBAAa,UAAU,eAAV,CAA0B,UAAU,OAApC,CAAb;AACH;AACJ,KALS,CAAV;;AAOA,sBAAkB,SAAS,YAAY;AACnC,eAAO,yBAAyB,EAAE,MAAF,CAAS,QAAQ,UAAR,EAAT,CAAzB,CAAP;AACH,KAFiB,EAEf,MAFe,CAER,EAAE,UAAU,IAAZ,EAFQ,CAAlB;;AAIA,aAAS,wBAAT,CAAkC,UAAlC,EAA8C;AAC1C,eAAO,WAAW,MAAX,CAAkB,UAAU,IAAV,EAAgB,SAAhB,EAA2B;AAChD,gBAAI,GAAJ;;AAEA,gBAAI,UAAU,cAAd,EAA8B;AAC1B,sBAAM,UAAU,cAAV,EAAN;AACA,oBAAI,GAAJ,EAAS;AACL,yBAAK,IAAL,CAAU,GAAV;AACA,2BAAO,IAAP;AACH;AACJ,aAND,MAOK;AACD,uBAAO,KAAK,MAAL,CAAa,yBAAyB,OAAO,UAAU,gBAAjB,KAAsC,EAA/D,CAAb,CAAP;AACH;;AAED,mBAAO,EAAE,OAAF,CAAU,KAAK,MAAL,CAAY,GAAZ,CAAV,CAAP;AACA,mBAAO,IAAP;AACH,SAhBM,EAgBJ,EAhBI,CAAP;AAiBH;;AAED,aAAS,SAAT,CAAmB,UAAnB,EAA+B;AAC3B,eAAO,mBAAG,MAAH,CAAU,UAAV,EAAsB,MAAtB,CAA6B,UAAU,SAAV,EAAqB,IAArB,EAA2B;AAC3D,gBAAI,KAAK,QAAL,IAAiB,OAAO,KAAK,QAAZ,KAAyB,UAA9C,EAA0D;AACtD,uBAAO,KAAK,QAAL,MAAmB,SAA1B;AACH,aAFD,MAEO;AACH,uBAAO,UAAU,KAAK,gBAAL,IAAyB,EAAnC,KAA0C,SAAjD;AACH;AACJ,SANM,EAMJ,KANI,CAAP;AAOH;;AAED,WAAO,oBAAM,IAAN,EAAY;AACf,wCADe;AAEf,sDAFe;AAGf,iBAAS,mBAAY;AACjB,iBAAK,OAAL,CAAa,UAAU,GAAV,EAAe;AACxB,oBAAI,OAAJ;AACH,aAFD;AAGH;AAPc,KAAZ,CAAP;AASH","file":"validationsViewModel.js","sourcesContent":["import ko from 'knockout';\r\nimport { merge } from 'scalejs';\r\nimport { receive } from 'scalejs.messagebus';\r\n\r\nexport default function validationsViewModel(node) {\r\n    let unwrap = ko.unwrap,\r\n        computed = ko.computed,\r\n        subs = [],\r\n        isInvalid,\r\n        visibleMessages,\r\n        showValidationMessages = ko.observable(true),\r\n        context = this;\r\n\r\n    subs.push(receive(context.id + '.validate', function (actionObj) {\r\n        isInvalid = _validate(_.values(context.dictionary()));\r\n        if (!isInvalid) {\r\n            actionObj && actionObj.successCallback(actionObj.options);\r\n        }\r\n    }));\r\n\r\n    visibleMessages = computed(function () {\r\n        return aggregateVisibleMessages(_.values(context.dictionary()));\r\n    }).extend({ deferred: true });\r\n\r\n    function aggregateVisibleMessages(childNodes) {\r\n        return childNodes.reduce(function (msgs, childNode) {\r\n            var msg;\r\n\r\n            if (childNode.visibleMessage) {\r\n                msg = childNode.visibleMessage();\r\n                if (msg) {\r\n                    msgs.push(msg);\r\n                    return msgs;\r\n                }\r\n            }\r\n            else {\r\n                msgs = msgs.concat((aggregateVisibleMessages(unwrap(childNode.mappedChildNodes) || [])));\r\n            }\r\n\r\n            msgs = _.compact(msgs.concat(msg));\r\n            return msgs;\r\n        }, []);\r\n    }\r\n\r\n    function _validate(childNodes) {\r\n        return ko.unwrap(childNodes).reduce(function (isInvalid, curr) {\r\n            if (curr.validate && typeof curr.validate === 'function') {\r\n                return curr.validate() || isInvalid;\r\n            } else {\r\n                return _validate(curr.mappedChildNodes || []) || isInvalid;\r\n            }\r\n        }, false);\r\n    }\r\n\r\n    return merge(node, {\r\n        visibleMessages,\r\n        showValidationMessages,\r\n        dispose: function () {\r\n            subs.forEach(function (sub) {\r\n                sub.dispose();\r\n            });\r\n        }\r\n    });\r\n}\r\n"]}